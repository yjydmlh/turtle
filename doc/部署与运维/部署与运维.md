# 部署与运维

<cite>
**本文档引用文件**   
- [run.py](file://run.py)
- [app/main.py](file://app/main.py)
- [app/core/config.py](file://app/core/config.py)
- [performance_recommendations.md](file://performance_recommendations.md)
- [frontend/performance_optimization.md](file://frontend/performance_optimization.md)
</cite>

## 目录
1. [生产环境部署](#生产环境部署)
2. [环境配置管理](#环境配置管理)
3. [日志记录与监控策略](#日志记录与监控策略)
4. [性能调优方案](#性能调优方案)
5. [健康检查端点](#健康检查端点)
6. [监控告警设置](#监控告警设置)

## 生产环境部署

为确保系统在生产环境中稳定高效运行，推荐采用Gunicorn + Uvicorn的部署架构。该组合结合了Gunicorn的进程管理能力和Uvicorn的异步处理优势，适用于高并发的FastAPI应用。

部署命令如下：
```bash
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

建议配置Nginx作为反向代理服务器，实现静态文件服务、负载均衡和SSL终止。前端资源应通过`/static`路径挂载，由Nginx直接提供服务以减轻应用服务器压力。

**Section sources**
- [run.py](file://run.py#L1-L11)
- [app/main.py](file://app/main.py#L1-L110)

## 环境配置管理

系统通过`app/core/config.py`文件集中管理所有配置项，采用Pydantic Settings进行类型安全的环境变量读取。关键配置包括：

- **DEBUG模式**：默认关闭，生产环境必须设置为`False`
- **SECRET_KEY**：必须通过环境变量设置，否则系统启动失败
- **数据库连接**：通过`DATABASE_URL`环境变量配置
- **CORS策略**：限制为特定开发域名，禁止使用通配符
- **API版本**：通过`API_V1_STR`统一管理

配置文件支持JSON格式的CORS来源列表，可通过环境变量灵活配置。建议在生产环境中使用`.env`文件管理敏感信息。

**Section sources**
- [app/core/config.py](file://app/core/config.py#L1-L66)

## 日志记录与监控策略

系统内置结构化日志系统，配置参数包括：
- **日志级别**：默认为DEBUG，生产环境建议设为INFO
- **日志格式**：包含时间戳、模块名、日志级别和消息
- **日志文件**：输出到`logs/app.log`，支持自动轮转

建议实施以下监控策略：
- 集成Prometheus进行指标收集
- 添加性能监控中间件
- 实现连接池状态监控
- 使用psutil监控内存使用情况

**Section sources**
- [app/core/config.py](file://app/core/config.py#L58-L62)
- [performance_recommendations.md](file://performance_recommendations.md#L15-L20)

## 性能调优方案

### 数据库优化
根据`database_optimization.sql`和性能建议，实施以下优化措施：
- 增加连接池大小至10，最大溢出连接数至20
- 延长连接回收时间为1小时
- 按时间对大表进行分区
- 对历史数据实施压缩存储和归档策略

### 缓存策略
建议引入Redis缓存热点数据，如最新K线数据。前端已实施分层缓存机制：
- 静态数据：30分钟缓存
- 一般数据：5分钟缓存
- 实时数据：30秒缓存

### 异步处理
对耗时操作（如数据获取和分析）使用FastAPI的BackgroundTasks进行异步处理，避免阻塞主线程。

### API限流
建议添加SlowAPI中间件实现API限流，防止滥用。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L22-L85)
- [frontend/performance_optimization.md](file://frontend/performance_optimization.md#L45-L55)

## 健康检查端点

系统提供`/health`端点用于健康检查，返回JSON格式的系统状态信息：

```json
{
  "status": "healthy",
  "message": "缠论分析系统运行正常",
  "version": "2.0.0",
  "components": {
    "api": "运行中",
    "database": "已连接",
    "chan_module": "已集成"
  }
}
```

该端点可用于：
- Kubernetes存活探针和就绪探针
- 负载均衡器健康检查
- 运维监控系统状态检测

**Section sources**
- [app/main.py](file://app/main.py#L100-L108)

## 监控告警设置

建议建立全面的监控告警体系：

### 基础监控
- **API响应时间**：监控关键端点的P95和P99延迟
- **错误率**：跟踪5xx和4xx错误比例
- **系统资源**：CPU、内存、磁盘使用率

### 数据库监控
- 连接池使用率
- 慢查询检测
- 查询性能分析

### 告警策略
- **严重告警**：API不可用、数据库断开连接
- **警告告警**：响应时间超过阈值、错误率上升
- **信息告警**：缓存命中率下降、连接池接近满载

建议使用Prometheus + Grafana + Alertmanager构建完整的监控告警平台。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L70-L75)
- [app/main.py](file://app/main.py#L100-L108)