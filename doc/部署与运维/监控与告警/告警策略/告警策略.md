# 告警策略

<cite>
**本文档引用的文件**  
- [performance_recommendations.md](file://performance_recommendations.md)
- [kline.py](file://app/api/v1/endpoints/kline.py)
- [exceptions.py](file://app/core/exceptions.py)
- [logger.py](file://app/core/logger.py)
- [session.py](file://app/db/session.py)
</cite>

## 目录
1. [引言](#引言)
2. [关键告警规则定义](#关键告警规则定义)
3. [日志系统与告警触发](#日志系统与告警触发)
4. [告警阈值建议](#告警阈值建议)
5. [告警通知渠道](#告警通知渠道)
6. [基于错误处理逻辑的告警触发点识别](#基于错误处理逻辑的告警触发点识别)
7. [告警抑制与去重策略](#告警抑制与去重策略)
8. [总结](#总结)

## 引言
本告警策略文档旨在为交易系统提供全面的监控与告警机制，确保系统在高负载、异常或潜在故障情况下能够及时响应。文档基于 `performance_recommendations.md` 中的性能优化建议，结合 `kline.py` 等核心模块的错误处理逻辑，定义关键告警场景、阈值、通知方式及去重机制，提升系统的可观测性与稳定性。

## 关键告警规则定义
根据系统架构与业务需求，定义以下关键告警规则：

- **API高延迟告警**：当API接口的P95响应时间超过500ms时触发，影响用户体验与数据实时性。
- **高错误率告警**：当HTTP 5xx错误率超过总请求的5%时触发，表明服务端存在严重问题。
- **数据库连接池饱和告警**：当数据库连接池使用率超过80%时触发，可能引发请求阻塞或超时。
- **内存使用过高告警**：当应用进程内存使用率超过80%时触发，存在内存溢出风险。
- **健康检查失败告警**：当 `/health` 端点返回非200状态码时触发，表明系统整体不可用。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L1-L107)
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L237-L259)
- [chan_analysis.py](file://app/api/v1/endpoints/chan_analysis.py#L392-L420)

## 日志系统与告警触发
系统使用结构化日志记录器 `app_logger`，支持按级别（DEBUG、INFO、ERROR）输出日志，并通过 `RotatingFileHandler` 实现日志轮转与归档。告警系统应集成日志监控，当出现以下情况时触发告警：

- **ERROR级别日志频繁出现**：如数据库连接失败、SQLAlchemy异常、无效参数等。
- **特定异常类被抛出**：如 `DatabaseException`、`ResourceNotFoundException`、`InvalidParameterException` 等。
- **健康检查日志中出现“❌”标记**：如 `app_logger.error(f"❌ 健康检查失败: {str(e)}")`。

日志系统已配置控制台和文件双输出，便于集中采集与分析。

**Section sources**
- [logger.py](file://app/core/logger.py#L0-L44)
- [exceptions.py](file://app/core/exceptions.py#L0-L110)
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L237-L259)

## 告警阈值建议
为避免误报与漏报，建议采用动态与静态结合的阈值策略：

| 告警类型 | 阈值 | 触发条件 | 持续时间 |
|--------|------|---------|--------|
| API高延迟 | P95 > 500ms | 连续5分钟超过阈值 | 5分钟 |
| HTTP 5xx错误率 | > 5% | 每分钟统计一次，超过5% | 2分钟 |
| 数据库连接池使用率 | > 80% | 基于 `pool_size=10`, `max_overflow=20` 计算 | 3分钟 |
| 内存使用率 | > 80% | 基于进程总内存 | 5分钟 |
| 健康检查失败 | HTTP状态码 ≠ 200 | 连续3次失败 | 1分钟 |

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L1-L107)
- [session.py](file://app/db/session.py#L0-L43)

## 告警通知渠道
为确保告警信息及时触达相关人员，建议配置多级通知渠道：

- **即时通讯（企业微信/钉钉）**：用于实时推送高优先级告警（如系统宕机、数据库不可用），确保开发与运维团队第一时间响应。
- **短信通知**：用于关键告警（如内存溢出、连接池耗尽），适用于夜间或紧急情况下的值班人员。
- **邮件通知**：用于低优先级告警或每日告警汇总报告，便于事后分析与归档。

建议根据告警等级（P0-P3）配置不同的通知策略，避免信息过载。

## 基于错误处理逻辑的告警触发点识别
通过分析 `app/api/v1/endpoints/kline.py` 中的错误处理逻辑，可识别出多个潜在的告警触发点：

- **无效交易品种请求**：当 `symbol` 不在 `SYMBOL_TO_MODEL` 映射中时，抛出 `InvalidParameterException`，应记录为异常请求。
- **资源未找到**：当 `get_by_id` 或 `get_by_timestamp` 返回 `None` 时，抛出 `ResourceNotFoundException`，可作为数据完整性监控指标。
- **数据库操作异常**：在 `try-except` 块中捕获的 `Exception` 被记录为ERROR日志并抛出500错误，是5xx错误率的主要来源。
- **聚合K线数据获取失败**：`read_aggregated_kline` 中的异常被封装为 `AppException` 并记录日志，应触发告警。

这些异常均通过统一的 `create_error_response` 和异常处理器进行响应，便于集中监控。

**Section sources**
- [kline.py](file://app/api/v1/endpoints/kline.py#L0-L194)
- [exceptions.py](file://app/core/exceptions.py#L0-L110)

## 告警抑制与去重策略
为避免告警风暴，需实施有效的抑制与去重机制：

- **时间窗口去重**：同一告警在10分钟内仅通知一次，防止重复刷屏。
- **告警升级机制**：若告警持续超过15分钟未恢复，自动升级通知级别（如从企业微信升级至短信）。
- **依赖告警抑制**：当数据库连接池饱和告警触发时，可暂时抑制由数据库超时引发的API高延迟告警，避免级联告警。
- **维护窗口静默**：在预定的维护时段内，自动静默非关键告警。

建议使用Prometheus + Alertmanager实现上述策略，结合标签（labels）进行告警分组与路由。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L1-L107)
- [kline.py](file://app/api/v1/endpoints/kline.py#L0-L194)

## 总结
本文档基于系统现有架构与代码实现，定义了一套完整的告警策略，涵盖关键指标监控、日志集成、阈值设定、通知渠道与去重机制。通过实施该策略，可显著提升系统的可观测性与故障响应能力，保障交易系统的稳定运行。