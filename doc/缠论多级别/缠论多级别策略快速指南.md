# 缠论多级别联立分析策略 - 快速指南

## 🚀 快速开始

### 1. 核心概念

**多级别联立分析** = 同时分析多个时间周期的缠论结构,当不同级别信号"共振"时,交易胜率显著提升

```
单级别分析胜率: 50-60%
多级别共振胜率: 70-90%
```

### 2. 运行示例

```bash
# 运行完整示例(包含5个场景演示)
cd G:\biz\trade-system\turtle
python examples/multi_level_strategy_example.py
```

**示例输出**:
```
[OK] 检测到A级共振!
   信号类型: 3buy
   参与级别: M5, M15, H1
   共振强度: 0.83
   共振等级: A
   入场价格: $42,500.00
   止损价格: $41,225.00
   风险收益比: 2.00:1
   仓位系数: 1.86
```

### 3. 集成到现有系统

```python
from app.services.multi_level_resonance import (
    MultiLevelResonanceDetector,
    Signal,
    detect_and_validate_resonance
)
from datetime import datetime

# 步骤1: 创建检测器
detector = MultiLevelResonanceDetector()

# 步骤2: 添加不同级别的信号(来自chan.py分析)
for level in ['M5', 'M15', 'M30', 'H1']:
    signal = Signal(
        level=level,
        signal_type='3buy',  # 三买信号
        timestamp=datetime.now(),
        price=42500.0,
        confidence=0.85,
        structure_detail={'bi': {}, 'duan': {}, 'zhongshu': {}}
    )
    detector.add_signal(signal)

# 步骤3: 检测共振并验证
resonance = detect_and_validate_resonance()

if resonance:
    print(f"共振强度: {resonance.strength:.2f}")
    print(f"共振等级: {resonance.grade.value}")
    print(f"建议仓位系数: {resonance.position_coefficient:.2f}")
    
    # 步骤4: 计算仓位
    equity = 10000  # 账户净值
    base_risk = 0.02  # 基础风险2%
    
    position_lots = (
        equity * base_risk * resonance.position_coefficient
    ) / (resonance.stop_loss_distance * 100)
    
    print(f"建议开仓: {position_lots:.2f}手")
```

## 📊 核心模块

### 1. 多级别共振检测器

**文件**: `app/services/multi_level_resonance.py`

**主要功能**:
- 信号缓存管理(按时间窗口)
- 共振检测与强度计算
- 五重验证机制
- 动态仓位系数计算

### 2. 时间窗口配置

```python
时间窗口(信号有效期):
- M5:  15分钟
- M15: 45分钟
- M30: 90分钟
- H1:  180分钟
- H4:  480分钟
```

### 3. 共振等级

| 等级 | 强度范围 | 预期胜率 | 仓位系数 |
|-----|---------|---------|---------|
| A+ | ≥0.85 | 90%+ | 2.0-2.5 |
| A  | 0.75-0.84 | 80%+ | 1.5-2.0 |
| B  | 0.65-0.74 | 70%+ | 1.0-1.5 |
| C  | 0.55-0.64 | 60%+ | 0.5-1.0 |
| D  | <0.55 | <60% | 不建议交易 |

## 🎯 核心算法

### 共振强度计算

```python
strength = (
    level_count_score      * 0.30 +  # 参与级别数量
    signal_quality_score   * 0.25 +  # 信号质量(三买>二买>一买)
    time_freshness_score   * 0.20 +  # 时效性
    structure_alignment    * 0.15 +  # 结构对应
    macd_consistency       * 0.10    # MACD一致性
)
```

### 仓位系数计算

```python
position_coefficient = (
    time_level_coef ×       # 级别数量系数
    structure_level_coef ×  # 结构对应系数
    signal_quality_coef     # 信号质量系数
)

范围限制: [0.5, 2.5]
```

### 仓位计算公式

```python
position_lots = (
    equity × base_risk × position_coefficient
) / (stop_loss_$ × 100)

# 限制
position_lots = min(max(lots, 0.01), 0.30)
```

## ✅ 五重验证

交易前必须通过的5道检验:

| 验证项 | 检查内容 |
|-------|---------|
| 方向一致性 | 所有级别是否同方向(全买或全卖) |
| 结构完整性 | 笔/段/中枢结构是否清晰 |
| 时间有效性 | 信号是否在有效期内,价格是否走远 |
| 风险收益比 | RRR >= 1.5:1 |
| 市场环境 | 波动率/财经事件/交易时段 |

## 📈 使用示例

### 场景1: 基础共振检测

```python
# 运行示例
from examples.multi_level_strategy_example import example_1_basic_resonance_detection
example_1_basic_resonance_detection()
```

### 场景2: 五重验证演示

```python
from examples.multi_level_strategy_example import example_2_five_layer_validation
example_2_five_layer_validation()
```

### 场景3: 动态仓位管理

```python
from examples.multi_level_strategy_example import example_3_dynamic_position_sizing
example_3_dynamic_position_sizing()
```

### 场景4: 完整交易流程

```python
from examples.multi_level_strategy_example import example_4_real_world_workflow
example_4_real_world_workflow()
```

### 场景5: 级别组合对比

```python
from examples.multi_level_strategy_example import example_5_multi_level_comparison
example_5_multi_level_comparison()
```

## 🛡️ 风险控制

### 单笔限制

```python
MAX_RISK_PER_TRADE = 0.05      # 单笔风险≤5%
MIN_STOP_LOSS = 5.0            # 最小止损$5
MAX_STOP_LOSS = 100.0          # 最大止损$100
MAX_POSITION_LOTS = 0.30       # 最大仓位0.30手
MIN_RISK_REWARD = 1.5          # 最小风险收益比1.5:1
```

### 总体限制

```python
MAX_TOTAL_POSITION = 0.50      # 总仓位≤50%
MAX_TOTAL_RISK = 0.08          # 总风险≤8%
MAX_CONCURRENT_TRADES = 3      # 最多3个持仓
```

### 熔断机制

| 级别 | 触发条件 | 动作 |
|-----|---------|------|
| 一级 | 单日亏损≥3% | 停止新开仓24小时 |
| 二级 | 单周亏损≥6% | 平仓+停止72小时 |
| 三级 | 回撤≥15% | 停止1-2周+复盘 |
| 四级 | 回撤≥25% | 完全停止系统 |

## 📚 文档资源

- **详细设计方案**: `doc/缠论多级别联立分析设计方案.md`
- **技术规范**: `doc/缠论分析模块/chan_multilevel_spec.md`
- **策略指南**: `CHAN_STRATEGY_GUIDE.md`
- **代码示例**: `examples/multi_level_strategy_example.py`
- **核心模块**: `app/services/multi_level_resonance.py`

## 🔧 下一步

### 立即可用

- ✅ 多级别共振检测
- ✅ 五重验证机制
- ✅ 动态仓位计算
- ✅ 基础风控限制

### 需要完善(建议)

- [ ] 与chan.py的深度集成
- [ ] 实时K线数据流接入
- [ ] 完整的止损止盈管理
- [ ] 熔断机制实现
- [ ] 回测框架
- [ ] 实盘API对接

## 💡 最佳实践

1. **级别选择**: 建议使用3-4个级别 (如M15+M30+H1或M5+M15+M30+H1)
2. **信号过滤**: 只交易共振强度≥0.65的B级以上信号
3. **仓位控制**: 严格遵守仓位系数,不要手动加仓
4. **风险管理**: 每笔交易风险控制在2-3%以内
5. **持续监控**: 定期复盘,优化参数

## ⚠️ 注意事项

- 本策略基于技术分析,无法预测突发事件
- 建议先在模拟盘充分测试
- 实盘从小资金开始($1000-3000)
- 严格执行止损,不要心存侥幸
- 参数需根据市场特性调整

## 🤝 支持

- **技术问题**: 查看代码注释和文档
- **策略讨论**: 参考`chan_multilevel_spec.md`
- **Bug反馈**: GitHub Issues

---

**免责声明**: 本策略仅供学习研究,不构成投资建议。实际交易有风险,请谨慎操作。

**版本**: v1.0  
**更新日期**: 2025-10-18

