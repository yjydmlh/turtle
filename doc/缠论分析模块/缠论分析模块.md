# 缠论分析模块

<cite>
**本文档引用文件**  
- [chan.py](file://chan.py/Chan.py)
- [ChanConfig.py](file://chan.py/ChanConfig.py)
- [KLine.py](file://chan.py/KLine/KLine.py)
- [Bi.py](file://chan.py/Bi/Bi.py)
- [Seg.py](file://chan.py/Seg/Seg.py)
- [ZS.py](file://chan.py/ZS/ZS.py)
- [BS_Point.py](file://chan.py/BuySellPoint/BS_Point.py)
- [chan_adapter.py](file://app/services/chan_adapter.py)
</cite>

## 目录
1. [引言](#引言)
2. [缠论基础概念](#缠论基础概念)
3. [核心类设计与算法实现](#核心类设计与算法实现)
4. [适配器集成](#适配器集成)
5. [配置与扩展](#配置与扩展)

## 引言
缠论分析模块是本系统的核心价值所在，基于缠中说禅理论构建，旨在提供一套完整的量化分析框架。该模块不仅实现了缠论的基本元素计算，还支持策略开发、机器学习模型对接以及线上交易功能。通过高度可配置的参数和灵活的扩展接口，开发者可以轻松定制分析逻辑或集成替代实现。

## 缠论基础概念
缠论是一种技术分析方法，主要通过分型、笔、线段和中枢（ZS）等基本元素来描述市场走势。以下是这些概念的简要介绍：

- **分型**：由三根相邻K线组成，顶分型的中间K线高点最高，底分型的中间K线低点最低。
- **笔**：连接两个相邻分型的线段，分为上升笔和下降笔。
- **线段**：由多笔构成的连续走势，具有明确的方向性和延续性。
- **中枢（ZS）**：价格在一定范围内反复波动形成的区域，通常由至少三笔重叠部分构成。

这些基本元素构成了缠论分析的基础，通过对它们的识别和组合，可以揭示市场的内在结构和趋势变化。

## 核心类设计与算法实现
### KLine 类
`KLine` 类用于表示合并后的K线，它是缠论分析中的基本单位之一。每个 `CKLine` 实例包含以下属性：
- `idx`：K线的索引。
- `lst`：包含所有单根K线的列表。
- `fx`：分型类型。
- `dir`：方向。
- `pre` 和 `next`：前一根和后一根合并K线。
- `high` 和 `low`：高点和低点。

此外，`CKLine` 提供了多种方法来检查分型的有效性，例如 `check_fx_valid` 方法可以根据不同的检查方法（如严格、半严格等）验证分型是否成立。

**Section sources**
- [KLine.py](file://chan.py/KLine/KLine.py#L0-L97)

### Bi 类
`Bi` 类代表一笔，是缠论分析中的重要组成部分。每个 `CBi` 实例包含以下属性：
- `begin_klc` 和 `end_klc`：起始和结束的合并K线。
- `dir`：方向。
- `idx`：索引。
- `is_sure`：是否确定。
- `seg_idx`：所属线段的索引。
- `parent_seg`：所属线段。
- `next` 和 `pre`：前一笔和后一笔。

`CBi` 类提供了丰富的计算方法，如 `get_begin_val` 和 `get_end_val` 用于获取笔的起止价格，`cal_macd_metric` 用于计算MACD指标的不同度量方式（如峰值、面积等）。

**Section sources**
- [Bi.py](file://chan.py/Bi/Bi.py#L0-L326)

### Seg 类
`Seg` 类表示线段，由多笔构成。每个 `CSeg` 实例包含以下属性：
- `idx`：索引。
- `start_bi` 和 `end_bi`：起始和结束的笔。
- `is_sure`：是否确定。
- `dir`：方向。
- `zs_lst`：包含的中枢列表。
- `pre` 和 `next`：前一线段和后一线段。
- `bi_list`：包含的笔列表。

`CSeg` 类提供了多种方法来计算线段的特性，如 `cal_klu_slope` 用于计算K线斜率，`cal_amp` 用于计算振幅，`cal_bi_cnt` 用于计算笔的数量。

**Section sources**
- [Seg.py](file://chan.py/Seg/Seg.py#L0-L153)

### ZS 类
`ZS` 类表示中枢，是价格在一定范围内反复波动形成的区域。每个 `CZS` 实例包含以下属性：
- `begin` 和 `end`：起始和结束的K线单元。
- `low` 和 `high`：中枢的低点和高点。
- `mid`：中枢的中点。
- `peak_low` 和 `peak_high`：中枢涉及的最低点和最高点。
- `bi_in` 和 `bi_out`：进入和离开中枢的笔。
- `bi_lst`：包含的笔列表。

`CZS` 类提供了多种方法来更新和合并中枢，如 `update_zs_range` 用于更新中枢范围，`combine` 用于合并相邻中枢。

**Section sources**
- [ZS.py](file://chan.py/ZS/ZS.py#L0-L234)

### BuySellPoint 类
`BuySellPoint` 类表示买卖点，是缠论分析中的关键决策点。每个 `CBS_Point` 实例包含以下属性：
- `bi`：关联的笔。
- `klu`：关联的K线单元。
- `is_buy`：是否为买点。
- `type`：买卖点类型。
- `relate_bsp1`：相关的一类买卖点。
- `features`：特征字典。

`CBS_Point` 类提供了多种方法来添加和管理买卖点类型，如 `add_type` 用于添加新的买卖点类型，`add_another_bsp_prop` 用于添加另一个买卖点属性。

**Section sources**
- [BS_Point.py](file://chan.py/BuySellPoint/BS_Point.py#L0-L38)

## 适配器集成
`chan_adapter.py` 文件中的 `ChanAdapter` 类作为适配器，将外部 `chan.py` 模块无缝集成到FastAPI应用中。它负责初始化 `chan.py` 模块，准备数据格式，并调用相应的分析方法。如果 `chan.py` 模块不可用，`ChanAdapter` 会使用简化分析作为后备方案。

`ChanAdapter` 的主要功能包括：
- 初始化 `chan.py` 模块。
- 准备K线数据以供 `chan.py` 模块使用。
- 调用 `chan.py` 模块进行分析。
- 将分析结果转换为标准格式。

**Section sources**
- [chan_adapter.py](file://app/services/chan_adapter.py#L0-L516)

## 配置与扩展
### ChanConfig.py
`ChanConfig.py` 文件定义了 `CChanConfig` 类，用于配置缠论分析的各种参数。这些参数包括：
- **中枢配置**：如 `zs_combine`（是否合并中枢）、`zs_combine_mode`（合并模式）等。
- **笔配置**：如 `bi_algo`（笔算法）、`bi_strict`（是否严格笔）等。
- **线段配置**：如 `seg_algo`（线段算法）、`left_seg_method`（剩余笔处理方法）等。
- **买卖点配置**：如 `divergence_rate`（背驰比例）、`min_zs_cnt`（最少中枢数）等。

通过这些配置，用户可以根据需要调整分析逻辑，以适应不同的市场环境和交易策略。

**Section sources**
- [ChanConfig.py](file://chan.py/ChanConfig.py#L0-L182)

### 扩展接口
为了支持自定义开发，`chan.py` 模块提供了多个扩展接口：
- **数据接入**：支持多种数据源，如 `DATA_SRC.FUTU`、`DATA_SRC.BAO_STOCK` 等。
- **实时数据接入**：支持实时股价数据接口，如 `AkShareSnapshot`、`FutuSnapshot` 等。
- **笔模型**：允许用户自定义笔的生成规则。
- **线段模型**：允许用户自定义线段的计算方法。
- **买卖点策略**：支持自定义买卖点策略，如 `CCustomStrategy`、`CSegBspStrategy` 等。

通过这些扩展接口，开发者可以轻松地集成自己的数据源、算法和策略，从而实现个性化的分析和交易系统。

**Section sources**
- [ChanConfig.py](file://chan.py/ChanConfig.py#L0-L182)
- [chan_adapter.py](file://app/services/chan_adapter.py#L0-L516)