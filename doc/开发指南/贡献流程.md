# 贡献流程

<cite>
**本文档引用的文件**
- [run.py](file://run.py)
- [quick_start.py](file://quick_start.py)
- [README.md](file://README.md)
- [test_chan_integration.py](file://test_chan_integration.py)
- [chan.py/README.md](file://chan.py/README.md)
</cite>

## 目录
1. [贡献流程概述](#贡献流程概述)
2. [开发环境启动](#开发环境启动)
3. [代码提交规范](#代码提交规范)
4. [分支管理策略](#分支管理策略)
5. [Pull Request审查标准](#pull-request审查标准)
6. [新贡献者指南](#新贡献者指南)
7. [社区参与](#社区参与)

## 贡献流程概述

本项目采用标准的开源贡献流程，从代码提交到Pull Request审查，确保代码质量和项目稳定性。贡献者需要遵循以下完整流程：

1. Fork项目仓库到个人账户
2. 创建功能分支进行开发
3. 在本地完成开发和测试
4. 提交符合规范的代码更改
5. 推送分支并创建Pull Request
6. 通过代码审查后合并

项目欢迎各种形式的贡献，包括但不限于：
- **问题报告**：在GitHub Issues中提交bug报告或功能建议
- **代码贡献**：Fork项目，创建功能分支，提交Pull Request
- **文档改进**：改进文档、添加示例、翻译内容
- **测试反馈**：测试新功能，提供使用反馈

**Section sources**
- [README.md](file://README.md#L401-L462)

## 开发环境启动

### 使用run.py启动

`run.py`是项目的主要启动脚本，用于启动FastAPI后端服务。该脚本配置了Uvicorn服务器的基本参数：

```python
import uvicorn
from app.core.config import settings

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG,
        workers=1
    )
```

使用方法：
```bash
python run.py
```

此脚本会读取配置文件中的HOST和PORT设置，启动API服务。

### 使用quick_start.py启动

`quick_start.py`是项目的快速启动管理器，提供了更完整的环境设置和启动流程。该脚本包含以下主要功能：

1. **环境检查**：检查Python版本、创建必要目录
2. **依赖验证**：检查数据库连接、Chan模块状态、依赖包
3. **数据获取**：可选择获取初始K线数据
4. **服务器启动**：启动系统并显示访问信息

主要功能模块：
- `check_python_version()`：检查Python版本是否符合要求（3.8+）
- `create_directories()`：创建static、logs、data等必要目录
- `check_database()`：检查数据库连接状态
- `check_chan_module()`：检查Chan模块集成状态
- `check_dependencies()`：验证必需的Python包是否已安装
- `fetch_initial_data()`：获取初始K线数据
- `start_server()`：启动服务器并显示访问信息

使用方法：
```bash
python quick_start.py
```

脚本会引导用户完成环境设置，并询问是否立即启动系统。启动后，系统会显示详细的访问信息，包括：
- API服务地址：http://localhost:8000
- API文档地址：http://localhost:8000/api/v1/docs
- 健康检查地址：http://localhost:8000/health

**Section sources**
- [run.py](file://run.py#L1-L11)
- [quick_start.py](file://quick_start.py#L1-L271)
- [README.md](file://README.md#L200-L225)

## 代码提交规范

### 提交信息格式

项目遵循标准的Git提交信息格式，确保提交历史清晰可读。提交信息应遵循以下格式：

```
<类型>: <描述>

[可选的正文]

[可选的脚注]
```

**类型**（type）必须是以下之一：
- `feat`：新增功能
- `fix`：错误修复
- `docs`：文档更新
- `style`：代码样式调整（不影响功能）
- `refactor`：代码重构
- `test`：测试相关更改
- `chore`：构建过程或辅助工具的变动

**示例**：
```bash
git commit -m "feat: 添加新的分析算法"
git commit -m "fix: 修复数据获取超时问题"
git commit -m "docs: 更新API文档"
git commit -m "style: 调整图表显示样式"
```

提交信息应简洁明了，准确描述更改内容。对于复杂的更改，可以在正文中提供更详细的说明。

### 功能验证

在提交代码前，必须进行充分的功能验证。项目提供了集成测试脚本`test_chan_integration.py`，用于验证系统各组件的正常工作：

```python
def run_integration_test():
    """运行集成测试"""
    tests = {
        "Chan模块导入": test_chan_module,
        "数据库连接": test_database_connection,
        "API端点": test_api_endpoints,
        "数据获取器": test_data_fetcher,
        "服务启动": test_service_startup
    }
```

运行测试：
```bash
python test_chan_integration.py
```

测试结果会生成详细的报告，包括通过的测试、失败的测试和警告信息。只有所有关键测试通过，才能提交代码。

**Section sources**
- [README.md](file://README.md#L435-L445)
- [test_chan_integration.py](file://test_chan_integration.py#L309-L383)

## 分支管理策略

项目采用功能分支工作流（Feature Branch Workflow），确保主分支的稳定性和代码质量。

### 分支命名规范

- **主分支**：`main` - 受保护的稳定分支，仅通过Pull Request合并
- **功能分支**：`feature/<功能名称>` - 用于开发新功能
- **修复分支**：`fix/<问题描述>` - 用于修复bug
- **发布分支**：`release/<版本号>` - 用于准备发布

**示例**：
```bash
git checkout -b feature/new-analysis-algorithm
git checkout -b fix/data-fetching-timeout
```

### 分支操作流程

1. **Fork项目**：
```bash
git clone https://github.com/your-username/turtle.git
cd turtle
```

2. **初始化子模块**（如果需要）：
```bash
git submodule update --init
```

3. **创建功能分支**：
```bash
git checkout -b feature/new-feature
```

4. **进行开发**：
```bash
# 进行代码修改...
```

5. **运行测试**：
```bash
python test_chan_integration.py
```

6. **提交更改**：
```bash
git add .
git commit -m "feat: 添加新功能"
git push origin feature/new-feature
```

7. **创建Pull Request**：在GitHub上创建PR，从`feature/new-feature`到`main`

### 分支保护规则

主分支`main`设置了以下保护规则：
- 禁止强制推送
- 要求Pull Request审查
- 要求状态检查通过（包括测试）
- 需要至少一个批准

这些规则确保了只有经过审查和测试的代码才能合并到主分支。

**Section sources**
- [README.md](file://README.md#L418-L434)

## Pull Request审查标准

所有Pull Request都需要经过严格的代码审查，确保代码质量和项目稳定性。审查标准包括以下方面：

### 代码质量

- **代码规范性**：遵循PEP 8规范，使用type hints，编写docstring文档
- **可读性**：代码结构清晰，命名规范，注释充分
- **可维护性**：避免重复代码，遵循单一职责原则
- **性能**：避免不必要的计算和内存使用

### 测试覆盖

- **单元测试**：新增功能必须包含相应的单元测试
- **集成测试**：确保新功能与现有系统集成正常
- **测试通过**：所有测试必须通过，包括现有的测试用例
- **测试覆盖率**：尽量提高测试覆盖率，特别是核心功能

### 文档更新

- **API文档**：新增或修改的API必须更新相应的文档
- **使用指南**：新功能需要在使用指南中添加说明
- **代码注释**：复杂的逻辑需要添加详细的代码注释
- **变更日志**：重要的变更需要记录在变更日志中

### 功能正确性

- **功能实现**：确保功能按预期工作
- **边界情况**：处理各种边界情况和异常情况
- **用户体验**：考虑用户使用场景，提供良好的用户体验
- **安全性**：避免安全漏洞，如SQL注入、XSS等

审查流程：
1. 提交Pull Request后，CI/CD系统会自动运行测试
2. 至少一名核心开发者进行代码审查
3. 根据审查意见进行修改
4. 所有审查通过后，由核心开发者合并

**Section sources**
- [README.md](file://README.md#L455-L462)

## 新贡献者指南

### 完整操作流程

新贡献者可以按照以下完整流程参与项目贡献：

1. **Fork项目**：
   - 访问项目GitHub页面
   - 点击"Fork"按钮创建个人副本

2. **克隆项目**：
```bash
git clone https://github.com/your-username/turtle.git
cd turtle
```

3. **初始化子模块**：
```bash
git submodule update --init
```

4. **安装依赖**：
```bash
pip install -r requirements.txt
```

5. **配置环境**：
   - 复制`.env.example`为`.env`
   - 编辑`.env`文件，配置数据库连接等

6. **创建数据库表**：
```bash
python create_tables.py
```

7. **创建功能分支**：
```bash
git checkout -b feature/your-feature-name
```

8. **开发和测试**：
   - 进行代码修改
   - 运行集成测试：
   ```bash
   python test_chan_integration.py
   ```

9. **启动开发环境**：
```bash
# 方式1：快速启动
python quick_start.py

# 方式2：手动启动
python run.py
```

10. **提交更改**：
```bash
git add .
git commit -m "feat: 描述你的更改"
git push origin feature/your-feature-name
```

11. **创建Pull Request**：
    - 在GitHub上访问你的fork
    - 点击"Compare & pull request"
    - 填写PR描述，说明更改内容和目的
    - 提交PR

### 功能验证方法

使用`quick_start.py`脚本可以快速验证功能：

```python
def start_server(self):
    """启动服务器"""
    print(f"📍 系统启动信息:")
    print(f"   🌐 API服务: http://localhost:{settings.PORT}")
    print(f"   📚 API文档: http://localhost:{settings.PORT}/api/v1/docs")
    print(f"   🔍 健康检查: http://localhost:{settings.PORT}/health")
```

启动后，可以通过以下方式验证功能：
- 访问API文档：http://localhost:8000/api/v1/docs
- 调用健康检查：curl http://localhost:8000/health
- 测试API端点：curl "http://localhost:8000/api/v1/simple/klines?timeframe=1h&limit=200"

### 常见问题解决

#### 数据库连接失败
```bash
# 检查PostgreSQL服务
sudo systemctl status postgresql  # Linux
brew services list | grep postgresql  # macOS

# 检查连接配置
psql -h localhost -U postgres -d turtle
```

#### Chan模块不可用
```bash
# 重新初始化子模块
git submodule update --init --recursive

# 检查模块状态
python -c "from app.services.chan_adapter import chan_adapter; print(chan_adapter.get_chan_info())"
```

#### API连接超时
```bash
# 检查网络连接
curl -I https://api.binance.com/api/v3/ping

# 调整超时配置（.env文件）
API_TIMEOUT=60
```

**Section sources**
- [README.md](file://README.md#L418-L434)
- [quick_start.py](file://quick_start.py#L1-L271)

## 社区参与

我们热烈欢迎社区成员参与项目贡献！通过协作，我们可以共同打造更优秀的缠论分析系统。

### 参与方式

1. **报告问题**：在GitHub Issues中提交bug报告或功能建议
2. **代码贡献**：Fork项目，创建功能分支，提交Pull Request
3. **文档改进**：改进文档、添加示例、翻译内容
4. **测试反馈**：测试新功能，提供使用反馈
5. **讨论交流**：在GitHub Discussions中参与技术讨论

### 贡献价值

您的贡献将帮助项目：
- 提高代码质量和稳定性
- 增加新功能和特性
- 改善用户体验
- 扩大社区影响力
- 促进技术交流和学习

### 支持和帮助

如果您在贡献过程中遇到任何问题，可以通过以下方式获取帮助：

- **文档**：查看本README和API文档
- **Issues**：在GitHub Issues中搜索相关问题
- **讨论**：在GitHub Discussions中参与讨论
- **项目主页**：https://github.com/your-username/turtle
- **问题反馈**：https://github.com/your-username/turtle/issues
- **功能建议**：https://github.com/your-username/turtle/discussions

我们感谢每一位贡献者的付出，共同推动项目向前发展！

**Section sources**
- [README.md](file://README.md#L401-L462)