# 开发环境搭建

<cite>
**本文档引用的文件**  
- [setup_project.py](file://setup_project.py)
- [requirements.txt](file://requirements.txt)
- [frontend/package.json](file://frontend/package.json)
- [create_tables.py](file://create_tables.py)
- [app/core/config.py](file://app/core/config.py)
- [app/db/session.py](file://app/db/session.py)
- [quick_start.py](file://quick_start.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目初始化](#项目初始化)
3. [依赖安装](#依赖安装)
4. [数据库配置](#数据库配置)
5. [常见问题与解决方案](#常见问题与解决方案)
6. [环境验证清单](#环境验证清单)

## 简介
本文档提供缠论分析系统（Turtle Trading System）的完整开发环境搭建指南。涵盖项目初始化、Python与前端依赖安装、数据库配置及环境验证流程。基于 `setup_project.py`、`create_tables.py` 和 `quick_start.py` 等脚本，指导开发者快速构建可运行的本地开发环境。

## 项目初始化

使用 `setup_project.py` 脚本可自动创建标准项目结构并生成必要文件。该脚本定义了核心目录和初始化文件，确保项目结构一致性。

### 执行项目初始化
```bash
python setup_project.py
```

脚本将创建以下目录结构：
```
app/
├── api/v1
├── core
├── db
├── models
├── schemas
├── services
├── utils
tests/
```

同时生成以下空文件以支持模块导入：
- `__init__.py` 文件（用于Python包识别）
- `.env` 环境变量配置文件
- `requirements.txt` 依赖声明
- `README.md` 项目说明

**Section sources**
- [setup_project.py](file://setup_project.py#L1-L36)

## 依赖安装

系统依赖分为后端Python依赖和前端JavaScript依赖，需分别安装。

### 后端依赖安装
后端依赖定义于根目录 `requirements.txt`，包含FastAPI、SQLAlchemy、Pandas等核心库。

安装命令：
```bash
pip install -r requirements.txt
```

关键依赖说明：
- **fastapi**: Web API框架
- **uvicorn**: ASGI服务器
- **sqlalchemy**: ORM数据库工具
- **ccxt**: 加密货币交易所API客户端
- **pandas**: 数据处理与分析
- **python-dotenv**: 环境变量加载

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L18)

### 前端依赖安装
前端基于Svelte框架构建，依赖定义于 `frontend/package.json`。

安装命令：
```bash
cd frontend
npm install
```

关键依赖说明：
- **svelte**: 前端UI框架
- **vite**: 构建工具
- **lightweight-charts**: 金融图表库
- **tailwindcss**: CSS框架

构建前端资源：
```bash
npm run build
```

构建后资源将输出至 `static/` 目录，供后端服务提供。

**Section sources**
- [frontend/package.json](file://frontend/package.json#L1-L53)

## 数据库配置

数据库配置是系统运行的关键环节，涉及环境变量设置和表结构初始化。

### 配置 DATABASE_URL 环境变量
在项目根目录创建 `.env` 文件，配置 `DATABASE_URL`：

```env
DATABASE_URL=postgresql://postgres:123456@127.0.0.1:5532/btc_usdt?client_encoding=utf8
```

或使用SQLite进行简单测试：
```env
DATABASE_URL=sqlite:///./turtle.db
```

配置项说明：
- **postgresql://**: 数据库类型
- **postgres:123456**: 用户名与密码
- **127.0.0.1:5532**: 主机与端口
- **btc_usdt**: 数据库名称

该配置在 `app/core/config.py` 中通过 `pydantic-settings` 加载，并作为SQLAlchemy引擎的连接字符串。

**Section sources**
- [app/core/config.py](file://app/core/config.py#L34-L34)
- [app/db/session.py](file://app/db/session.py#L7-L7)

### 创建数据库表结构
使用 `create_tables.py` 脚本初始化数据库表。

执行命令：
```bash
python create_tables.py
```

脚本功能流程：
1. 导入模型定义（如 `BtcUsdtKline`）
2. 测试数据库连接
3. 调用 `Base.metadata.create_all()` 创建所有表
4. 验证表结构与记录数

成功输出示例：
```
✅ 数据库连接成功
✅ btc_usdt表: 存在 (0 条记录)
✅ 数据库表创建成功！
```

支持的命令行参数：
- `--check`: 检查数据库状态
- `--reset`: 重置数据库（删除并重建）

**Section sources**
- [create_tables.py](file://create_tables.py#L1-L190)

## 常见问题与解决方案

### 模块导入错误
**问题现象**：
```
ImportError: No module named 'app'
```

**解决方案**：
1. 确保项目根目录包含 `__init__.py` 文件
2. 将项目根目录添加至Python路径：
   ```python
   import sys
   from pathlib import Path
   sys.path.insert(0, str(Path(__file__).parent))
   ```
3. 使用虚拟环境隔离依赖

### 数据库连接失败
**问题现象**：
```
数据库连接失败: could not connect to server
```

**解决方案**：
1. **检查数据库服务**：确保PostgreSQL已启动
   ```bash
   sudo service postgresql start
   ```
2. **创建数据库**：
   ```sql
   CREATE DATABASE turtle;
   ```
3. **验证连接配置**：检查 `.env` 文件中 `DATABASE_URL` 格式
4. **使用SQLite测试**：临时切换至 `sqlite:///./turtle.db` 验证代码逻辑

### 依赖包缺失
**问题现象**：
```
ModuleNotFoundError: No module named 'fastapi'
```

**解决方案**：
1. 安装所有依赖：
   ```bash
   pip install -r requirements.txt
   ```
2. 使用虚拟环境：
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

### Chan模块不可用
**问题现象**：
```
Chan模块检查失败
```

**解决方案**：
1. 初始化Git子模块：
   ```bash
   git submodule update --init
   ```
2. 确保 `chan.py` 目录存在且结构完整

**Section sources**
- [quick_start.py](file://quick_start.py#L1-L270)
- [create_tables.py](file://create_tables.py#L1-L190)

## 环境验证清单

完成环境搭建后，请按以下清单验证系统状态：

✅ **Python环境**
- [ ] Python 3.8+ 已安装
- [ ] 虚拟环境已创建（推荐）
- [ ] `pip install -r requirements.txt` 执行成功

✅ **项目结构**
- [ ] `setup_project.py` 已执行
- [ ] `app/` 目录结构完整
- [ ] `__init__.py` 文件存在

✅ **数据库配置**
- [ ] `.env` 文件已创建
- [ ] `DATABASE_URL` 配置正确
- [ ] PostgreSQL服务已启动（或SQLite路径可写）
- [ ] `python create_tables.py` 执行成功

✅ **前端资源**
- [ ] `cd frontend && npm install` 已执行
- [ ] `npm run build` 已执行
- [ ] `static/` 目录包含构建资源

✅ **系统启动**
- [ ] `python quick_start.py` 可正常启动
- [ ] 访问 `http://localhost:8000/api/v1/docs` 可查看API文档
- [ ] `GET /health` 返回健康状态

完成以上验证后，开发环境即已准备就绪，可进行后续开发与测试。

**Section sources**
- [quick_start.py](file://quick_start.py#L1-L270)
- [create_tables.py](file://create_tables.py#L1-L190)