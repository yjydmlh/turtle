# 数据模型

<cite>
**本文档引用的文件**
- [base_class.py](file://app/db/base_class.py)
- [kline.py](file://app/models/kline.py)
- [session.py](file://app/db/session.py)
- [database_optimization.sql](file://database_optimization.sql)
- [kline.py](file://app/crud/kline.py)
</cite>

## 目录
1. [引言](#引言)
2. [K线数据模型设计](#k线数据模型设计)
3. [ORM实现与基类设计](#orm实现与基类设计)
4. [数据库会话管理](#数据库会话管理)
5. [数据库优化策略](#数据库优化策略)
6. [数据生命周期管理](#数据生命周期管理)
7. [数据库Schema图](#数据库schema图)
8. [样本数据记录](#样本数据记录)
9. [结论](#结论)

## 引言
本文档详细描述了交易系统中K线数据的存储设计。重点分析了K线数据模型（kline）的字段定义、基于SQLAlchemy的ORM实现、数据库会话管理机制以及针对时序数据的优化策略。通过结合数据库优化脚本，阐述了分区、索引和查询优化等关键技术，确保系统能够高效处理大量时序数据。

## K线数据模型设计

### 核心字段定义
K线数据模型包含以下核心字段，用于完整记录每个时间周期的市场交易信息：

- **timestamp**：`BigInteger`类型，表示K线开始时间戳（毫秒），非空且建立索引以支持高效时间范围查询。
- **open_time**：`DateTime`类型，表示K线开始时间，非空，用于人类可读的时间表示。
- **close_time**：`DateTime`类型，表示K线结束时间，非空，与open_time共同定义K线周期。
- **open_price**：`Numeric(20, 8)`类型，开盘价，精度为8位小数，满足加密货币高精度需求。
- **high_price**：`Numeric(20, 8)`类型，最高价，非空，记录周期内最高成交价。
- **low_price**：`Numeric(20, 8)`类型，最低价，非空，记录周期内最低成交价。
- **close_price**：`Numeric(20, 8)`类型，收盘价，非空，用于技术分析计算。
- **volume**：`Numeric(30, 8)`类型，成交量，非空，记录周期内交易的基础货币数量。
- **quote_volume**：`Numeric(30, 8)`类型，成交额（计价货币），非空，用于价值计算。
- **trades_count**：`Integer`类型，成交笔数，非空，反映市场活跃度。
- **taker_buy_volume**：`Numeric(30, 8)`类型，主动买入成交量，非空，用于分析市场情绪。
- **taker_buy_quote_volume**：`Numeric(30, 8)`类型，主动买入成交额，非空。
- **created_at**：`DateTime`类型，数据创建时间，非空，默认值为当前时间。
- **updated_at**：`DateTime`类型，数据更新时间，非空，默认值为当前时间，并在更新时自动刷新。

### 数据约束与索引
- **主键约束**：`id`字段作为主键，自增且建立索引。
- **非空约束**：所有业务关键字段均设置为非空，确保数据完整性。
- **时间戳索引**：`timestamp`字段建立索引，加速基于时间戳的查询。
- **时间范围索引**：`open_time`和`close_time`字段建立复合索引，优化时间范围查询性能。

**Section sources**
- [kline.py](file://app/models/kline.py#L3-L21)

## ORM实现与基类设计

### 基类设计 (base_class.py)
系统采用SQLAlchemy的DeclarativeBase作为ORM基类，实现了自动表名生成和通用字段定义：

- **Base类**：继承自`DeclarativeBase`，作为所有模型的基类。
- **__tablename__自动生成**：通过`@declared_attr`装饰器，自动将类名转换为小写作为表名，减少重复配置。
- **通用字段**：定义了`id`作为主键字段，所有继承该基类的模型自动拥有此字段。

### K线模型继承结构
K线模型采用抽象基类模式，实现代码复用和灵活扩展：

- **Kline抽象基类**：继承自`Base`，定义了所有K线数据的通用字段和约束，设置`__abstract__ = True`防止直接实例化。
- **具体表模型**：`BtcUsdtKline`和`EthUsdtKline`继承自`Kline`，分别对应BTC/USDT和ETH/USDT交易对，通过`__tablename__`指定具体表名。
- **交易对映射**：`SYMBOL_TO_MODEL`字典实现了交易对符号到模型类的动态映射，便于扩展新的交易对。

**Section sources**
- [base_class.py](file://app/db/base_class.py#L0-L12)
- [kline.py](file://app/models/kline.py#L3-L36)

## 数据库会话管理

### 数据库引擎配置
`session.py`文件中配置了数据库引擎，优化了连接池和性能参数：

- **连接池配置**：`pool_size=10`，`max_overflow=20`，有效管理数据库连接，避免频繁创建销毁。
- **连接检测**：`pool_pre_ping=True`，自动检测连接有效性，提高稳定性。
- **超时设置**：`pool_timeout=30`秒，`connect_timeout=10`秒，防止连接阻塞。
- **调试模式**：`echo=settings.DEBUG`，在调试模式下输出SQL语句，便于开发调试。

### 会话工厂与依赖注入
- **SessionLocal**：会话工厂，配置为非自动提交和非自动刷新，提供细粒度事务控制。
- **get_db函数**：生成器函数，用于FastAPI依赖注入，确保每个请求获得独立的数据库会话，并在请求结束时正确关闭，同时处理异常回滚。

**Section sources**
- [session.py](file://app/db/session.py#L0-L43)

## 数据库优化策略

### 索引优化
`database_optimization.sql`脚本提供了针对K线数据表的索引优化建议：

- **时间降序索引**：`idx_btc_usdt_open_time`在`open_time`上建立降序索引，优化最新数据查询。
- **时间戳索引**：`idx_btc_usdt_timestamp`在`timestamp`上建立索引，支持毫秒级时间戳查询。
- **时间范围复合索引**：`idx_btc_usdt_time_range`在`open_time`和`close_time`上建立复合索引，显著提升时间范围查询效率。

### 查询优化与统计分析
- **ANALYZE命令**：定期执行`ANALYZE`命令更新表统计信息，帮助查询优化器生成更优的执行计划。
- **原生SQL聚合查询**：在`CRUDKline.get_kline_data`方法中，使用原生SQL结合`time_bucket`函数进行高效的时间序列聚合，避免在应用层处理大量数据。

### 数据库配置建议
脚本中还包含了PostgreSQL的配置优化建议：
- **内存设置**：调整`shared_buffers`和`effective_cache_size`以充分利用系统内存。
- **I/O优化**：设置`random_page_cost`和`effective_io_concurrency`以适应SSD存储。
- **WAL优化**：调整`wal_buffers`和`checkpoint_completion_target`以平衡写入性能和恢复时间。

**Section sources**
- [database_optimization.sql](file://database_optimization.sql#L0-L37)
- [kline.py](file://app/crud/kline.py#L200-L250)

## 数据生命周期管理

### 数据获取
- **数据获取脚本**：`simple_fetch_data.py`和`fetch_binance_data.py`脚本负责从币安API获取实时和历史K线数据。
- **批量获取**：脚本按天分批获取数据，避免单次请求过多数据导致API限制。
- **错误处理**：包含连接测试和异常处理机制，确保数据获取的可靠性。

### 数据更新
- **CRUD操作**：`CRUDKline`类提供了`create`、`update`、`bulk_create`等方法，支持单条和批量数据操作。
- **自动时间戳**：`created_at`和`updated_at`字段由数据库自动管理，确保时间一致性。

### 归档策略
- **定期维护**：建议通过`VACUUM ANALYZE`和`REINDEX`等命令进行定期维护，保持数据库性能。
- **数据归档**：虽然当前代码未直接实现，但可通过创建历史归档表或使用分区表的旧分区删除策略来管理过期数据。

**Section sources**
- [kline.py](file://app/crud/kline.py#L0-L354)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py#L308-L350)

## 数据库Schema图

```mermaid
erDiagram
KLINE ||--o{ BTC_USDT : inherits
KLINE ||--o{ ETH_USDT : inherits
class KLINE {
+int id PK
+bigint timestamp
+datetime open_time
+datetime close_time
+numeric(20,8) open_price
+numeric(20,8) high_price
+numeric(20,8) low_price
+numeric(20,8) close_price
+numeric(30,8) volume
+numeric(30,8) quote_volume
+int trades_count
+numeric(30,8) taker_buy_volume
+numeric(30,8) taker_buy_quote_volume
+datetime created_at
+datetime updated_at
}
class BTC_USDT {
+int id PK
<<Table>>
}
class ETH_USDT {
+int id PK
<<Table>>
}
```

**Diagram sources**
- [kline.py](file://app/models/kline.py#L3-L36)

## 样本数据记录
以下为一条典型的K线数据记录示例：

| 字段 | 值 |
| :--- | :--- |
| id | 12345 |
| timestamp | 1700000000000 |
| open_time | 2023-11-15 00:00:00 |
| close_time | 2023-11-15 00:59:59 |
| open_price | 35000.00000000 |
| high_price | 35500.00000000 |
| low_price | 34800.00000000 |
| close_price | 35200.00000000 |
| volume | 100.50000000 |
| quote_volume | 3530000.00000000 |
| trades_count | 1500 |
| taker_buy_volume | 55.25000000 |
| taker_buy_quote_volume | 1940000.00000000 |
| created_at | 2023-11-15 01:00:01 |
| updated_at | 2023-11-15 01:00:01 |

## 结论
本文档全面阐述了交易系统的K线数据存储设计。通过精心设计的数据模型、高效的ORM实现、稳健的会话管理以及针对时序数据的优化策略，系统能够可靠地存储和查询海量K线数据。未来可进一步实施数据分区和归档策略，以应对长期数据增长带来的挑战。