# 代码规范

<cite>
**本文档引用的文件**  
- [main.py](file://app/main.py)
- [Chan.py](file://chan.py/Chan.py)
- [api.js](file://frontend/src/lib/api.js)
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py)
- [chan_analysis.py](file://app/api/v1/endpoints/chan_analysis.py)
- [config.py](file://app/core/config.py)
- [kline_aggregator.py](file://app/services/kline_aggregator.py)
- [chan_adapter.py](file://app/services/chan_adapter.py)
- [svelte.config.js](file://frontend/svelte.config.js)
- [vite.config.js](file://frontend/vite.config.js)
</cite>

## 目录
1. [引言](#引言)
2. [Python代码规范](#python代码规范)
3. [Svelte前端代码规范](#svelte前端代码规范)
4. [代码审查检查点](#代码审查检查点)
5. [结论](#结论)

## 引言

本代码规范文档旨在为缠论分析系统项目提供统一的编码标准，确保代码质量、可读性和一致性。文档涵盖Python后端和Svelte前端两大部分，基于项目中实际存在的代码文件（如`main.py`、`Chan.py`和`api.js`）制定具体规范。通过遵循PEP 8规范、使用类型注解以及保持代码风格一致，我们致力于构建一个健壮、可维护的交易分析系统。

## Python代码规范

本节基于项目中的Python代码（如`main.py`和`Chan.py`）制定编码规范，旨在确保代码的可读性、一致性和可维护性。

### 命名约定

遵循PEP 8命名约定，确保代码清晰易懂。

- **变量和函数名**：使用小写字母和下划线分隔（snake_case）。
  ```python
  # 正确示例
  kline_aggregator = KlineAggregator()
  def get_supported_timeframes():
  ```

- **类名**：使用驼峰命名法（PascalCase）。
  ```python
  # 正确示例
  class KlineAggregator:
  class CChan:
  ```

- **常量**：使用大写字母和下划线分隔。
  ```python
  # 正确示例
  TIMEFRAMES = {
      '1m': 1,
      '5m': 5,
      '15m': 15,
  }
  ```

- **私有成员**：以单下划线开头表示内部使用。
  ```python
  # 正确示例
  def _aggregate_dataframe(self, df: pd.DataFrame, interval_minutes: int) -> pd.DataFrame:
  ```

**Section sources**
- [kline_aggregator.py](file://app/services/kline_aggregator.py#L1-L250)
- [Chan.py](file://chan.py/Chan.py#L1-L298)

### 代码组织

保持代码结构清晰，逻辑分明。

- **导入顺序**：遵循标准顺序：标准库、第三方库、项目内库，并使用空行分隔。
  ```python
  # 正确示例
  from typing import List, Dict, Optional
  from datetime import datetime
  from decimal import Decimal

  import pandas as pd
  from sqlalchemy.orm import Session
  from sqlalchemy import and_

  from app.models.kline import BtcUsdtKline
  from app.core.logger import app_logger
  ```

- **类和函数分隔**：类之间使用两个空行，方法之间使用一个空行。
- **模块级代码**：将模块级的初始化代码放在文件末尾，如创建全局实例。
  ```python
  # 正确示例
  kline_aggregator = KlineAggregator()
  ```

**Section sources**
- [kline_aggregator.py](file://app/services/kline_aggregator.py#L1-L250)
- [chan_adapter.py](file://app/services/chan_adapter.py#L1-L516)

### 文档字符串格式

使用Google风格的文档字符串，提供清晰的API文档。

- **函数文档**：包含参数、返回值和异常说明。
  ```python
  def aggregate_klines(
          self,
          db: Session,
          timeframe: str,
          start_time: Optional[datetime] = None,
          end_time: Optional[datetime] = None,
          limit: int = 200
  ) -> List[Dict]:
      """
      聚合K线数据

      Args:
          db: 数据库会话
          timeframe: 目标时间周期 (1m, 5m, 15m, 30m, 1h, 4h, 1d)
          start_time: 开始时间
          end_time: 结束时间
          limit: 返回数据条数限制

      Returns:
          List[Dict]: 聚合后的K线数据
      """
  ```

- **类文档**：在类定义下方提供类的总体描述。
  ```python
  class KlineAggregator:
      """K线数据聚合器 - 将1分钟K线聚合为不同时间周期"""
  ```

**Section sources**
- [kline_aggregator.py](file://app/services/kline_aggregator.py#L48-L77)
- [chan_analysis.py](file://app/api/v1/endpoints/chan_analysis.py#L44-L420)

### 类型注解

在所有函数和方法中强制使用类型注解，提高代码的可读性和可维护性。

- **函数参数和返回值**：明确指定类型。
  ```python
  def get_klines(
          timeframe: str = Query("1h", description="时间周期"),
          limit: int = Query(200, ge=1, le=1000, description="数据条数"),
          start_time: Optional[str] = Query(None, description="开始时间 (ISO格式)"),
          end_time: Optional[str] = Query(None, description="结束时间 (ISO格式)"),
          db: Session = Depends(get_db)
  ):
  ```

- **变量声明**：在复杂数据结构中使用类型注解。
  ```python
  raw_klines: List[BtcUsdtKline] = db.query(BtcUsdtKline).filter(...).all()
  ```

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L14-L259)
- [kline_aggregator.py](file://app/services/kline_aggregator.py#L48-L77)

## Svelte前端代码规范

本节基于`api.js`等前端文件，为Svelte项目定义编码标准。

### 命名约定

与Python后端保持一致的命名风格。

- **变量和函数**：使用camelCase。
  ```javascript
  // 正确示例
  const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';
  async function getKlines(timeframe = '1h', limit = 200, startTime = null, endTime = null) {
  ```

- **类和构造函数**：使用PascalCase。
  ```javascript
  class ApiError extends Error {
  }
  ```

- **常量**：使用UPPER_CASE。
  ```javascript
  const REQUEST_TIMEOUT = 30000;
  const CACHE_DURATION = 5 * 60 * 1000;
  ```

**Section sources**
- [api.js](file://frontend/src/lib/api.js#L1-L554)
- [stores.js](file://frontend/src/lib/stores.js#L1-L442)

### 代码组织

保持前端代码结构清晰，模块化。

- **模块导入**：按逻辑分组导入。
  ```javascript
  // 正确示例
  import { writable, derived } from 'svelte/store';

  // =============================================================================
  // 基础数据存储
  // =============================================================================

  export const klineStore = writable([]);
  ```

- **函数分组**：使用注释块对相关函数进行分组。
- **导出顺序**：先导出变量和函数，最后导出配置对象。

**Section sources**
- [api.js](file://frontend/src/lib/api.js#L1-L554)
- [stores.js](file://frontend/src/lib/stores.js#L1-L442)

### 模块化和可重用性

- **API封装**：将API调用封装在独立的模块中，如`api.js`。
- **状态管理**：使用Svelte的`writable`和`derived` store进行状态管理。
- **函数复用**：将通用功能（如缓存、错误处理）抽象为可复用函数。

**Section sources**
- [api.js](file://frontend/src/lib/api.js#L1-L554)
- [stores.js](file://frontend/src/lib/stores.js#L1-L442)

### 类型安全

- **JSDoc注解**：在复杂函数上使用JSDoc提供类型信息。
  ```javascript
  /**
   * 获取K线数据
   * @param {string} timeframe - 时间周期
   * @param {number} limit - 数据条数
   * @param {string|null} startTime - 开始时间
   * @param {string|null} endTime - 结束时间
   * @returns {Promise<Object>} K线数据响应
   */
  export async function getKlines(timeframe = '1h', limit = 200, startTime = null, endTime = null) {
  ```

**Section sources**
- [api.js](file://frontend/src/lib/api.js#L1-L554)

## 代码审查检查点

在代码审查时，重点关注以下关键点以确保代码质量。

### Python审查要点

- **命名一致性**：检查所有标识符是否遵循snake_case和PascalCase约定。
- **类型注解完整性**：确认所有函数都有完整的参数和返回值类型注解。
- **文档字符串质量**：验证文档字符串是否完整描述了参数、返回值和异常。
- **代码复杂度**：避免过长的函数，单个函数应保持在50行以内。
- **异常处理**：确保关键操作都有适当的异常处理。
- **PEP 8合规性**：使用工具检查代码是否符合PEP 8标准。

### Svelte审查要点

- **API调用封装**：检查API调用是否都通过`api.js`模块进行。
- **状态管理**：验证状态是否正确使用Svelte store管理。
- **错误处理**：确认所有异步操作都有错误处理机制。
- **性能优化**：检查是否有不必要的重新渲染，是否使用了适当的缓存策略。
- **代码复用**：确保通用功能被正确抽象和复用。

### 通用审查要点

- **代码一致性**：整个项目应保持统一的编码风格。
- **安全性**：检查是否有潜在的安全漏洞，如XSS、CSRF等。
- **可测试性**：代码是否易于单元测试和集成测试。
- **性能影响**：评估代码变更对系统性能的影响。

**Section sources**
- [main.py](file://app/main.py#L1-L110)
- [api.js](file://frontend/src/lib/api.js#L1-L554)
- [kline_aggregator.py](file://app/services/kline_aggregator.py#L1-L250)

## 结论

本代码规范为缠论分析系统项目提供了全面的编码指导。通过严格遵循Python的PEP 8规范、使用类型注解、保持命名一致性以及实施模块化的前端架构，我们可以确保代码库的高质量和可维护性。在代码审查过程中，应重点关注命名、类型安全、文档完整性和代码组织等关键检查点。所有开发人员都应遵守这些规范，共同维护一个健壮、清晰且高效的代码库。