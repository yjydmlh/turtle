# 部署环境配置

<cite>
**本文档引用的文件**   
- [run.py](file://run.py)
- [app/core/config.py](file://app/core/config.py)
- [performance_recommendations.md](file://performance_recommendations.md)
- [frontend/vite.config.js](file://frontend/vite.config.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心配置项详解](#核心配置项详解)
4. [开发与生产环境配置](#开发与生产环境配置)
5. [Gunicorn + Uvicorn 部署配置](#gunicorn--uvicorn-部署配置)
6. [Nginx 反向代理配置](#nginx-反向代理配置)
7. [Docker 部署优化建议](#docker-部署优化建议)
8. [结论](#结论)

## 简介
本文档旨在为“龟甲交易系统”（Turtle Trading System）提供完整的部署环境配置指南。基于 `run.py` 中的 Uvicorn 启动配置和 `app/core/config.py` 中的设置，详细说明开发环境与生产环境的配置方法。涵盖关键配置项如 HOST、PORT、DEBUG 的含义与最佳实践，介绍如何通过环境变量安全管理敏感信息（如 SECRET_KEY），并提供 Gunicorn+Uvicorn、Nginx 和 Docker 的完整部署优化方案。

## 项目结构
本项目采用分层架构设计，主要分为后端应用（app）、前端（frontend）、核心算法模块（chan.py）以及部署与配置脚本。后端基于 FastAPI 框架构建，前端使用 SvelteKit，整体结构清晰，便于维护和扩展。

```mermaid
graph TD
subgraph "Backend"
A[app/main.py]
B[app/core/config.py]
C[app/api/v1]
D[app/db/session.py]
end
subgraph "Frontend"
E[frontend/src]
F[frontend/vite.config.js]
end
subgraph "Core Logic"
G[chan.py/Chan.py]
H[chan.py/KLine]
end
subgraph "Deployment"
I[run.py]
J[Dockerfile]
K[performance_recommendations.md]
end
A --> B
A --> C
I --> A
F --> A
```

**Diagram sources**
- [run.py](file://run.py#L1-L10)
- [app/core/config.py](file://app/core/config.py#L1-L65)
- [frontend/vite.config.js](file://frontend/vite.config.js#L1-L52)

**Section sources**
- [run.py](file://run.py#L1-L10)
- [app/core/config.py](file://app/core/config.py#L1-L65)

## 核心配置项详解
系统的核心配置集中于 `app/core/config.py` 文件中，通过 Pydantic 的 `BaseSettings` 实现环境变量驱动的配置管理，确保灵活性与安全性。

### 关键配置字段说明
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `APP_NAME` | "turtle" | 应用名称，用于日志和监控 |
| `DEBUG` | False | 是否启用调试模式，开发环境设为 True |
| `SECRET_KEY` | "" | JWT 签名密钥，必须通过环境变量设置 |
| `HOST` | "0.0.0.0" | 服务监听地址，生产环境建议绑定内网IP |
| `PORT` | 8000 | HTTP 服务端口 |
| `WS_HOST` | "0.0.0.0" | WebSocket 监听地址 |
| `WS_PORT` | 8001 | WebSocket 端口 |
| `DATABASE_URL` | postgresql://... | 数据库连接字符串 |
| `CORS_ORIGINS` | ["*"] | 允许跨域的源列表，生产环境应明确指定 |
| `LOG_LEVEL` | "DEBUG" | 日志级别，生产环境建议设为 "INFO" 或 "WARNING" |

### 敏感信息安全管理
`SECRET_KEY` 被设计为必须通过环境变量设置，若未设置将抛出 `ValueError` 异常，防止因密钥缺失导致的安全漏洞。建议在 `.env` 文件或容器编排平台（如 Kubernetes Secrets）中安全存储该值。

**Section sources**
- [app/core/config.py](file://app/core/config.py#L1-L65)

## 开发与生产环境配置
通过环境变量灵活切换开发与生产配置，无需修改代码。

### 开发环境配置
```env
DEBUG=true
HOST=0.0.0.0
PORT=8000
SECRET_KEY=dev-secret-key-change-in-production
CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
LOG_LEVEL=DEBUG
```

### 生产环境配置
```env
DEBUG=false
HOST=192.168.1.100
PORT=8000
SECRET_KEY=your-very-long-and-random-secret-key-here
CORS_ORIGINS=https://yourdomain.com,https://api.yourdomain.com
LOG_LEVEL=INFO
DATABASE_URL=postgresql://user:securepassword@prod-db-host:5432/proddb
```

### 配置加载机制
系统通过 `load_dotenv()` 自动加载 `.env` 文件，并结合 `os.getenv()` 提供默认值，确保配置的灵活性与健壮性。

**Section sources**
- [app/core/config.py](file://app/core/config.py#L1-L65)

## Gunicorn + Uvicorn 部署配置
为提升生产环境的并发处理能力，推荐使用 Gunicorn 作为进程管理器，Uvicorn 作为 ASGI Worker。

### 部署命令
```bash
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 配置参数说明
| 参数 | 建议值 | 说明 |
|------|--------|------|
| `-w` (workers) | CPU 核心数 × 2 + 1 | 工作进程数，平衡资源利用与上下文切换开销 |
| `-k` | uvicorn.workers.UvicornWorker | 指定使用 Uvicorn Worker |
| `--bind` | 0.0.0.0:8000 | 绑定地址和端口 |
| `--workers` | 4 | 示例：4 核 CPU 可设为 4-5 个进程 |
| `--threads` | 2 | 每个进程启用多线程以处理阻塞型任务 |

### 负载均衡策略
建议在 Gunicorn 前部署 Nginx 实现负载均衡，将请求分发至多个 Gunicorn 工作进程，提升系统吞吐量和可用性。

**Section sources**
- [run.py](file://run.py#L1-L10)
- [performance_recommendations.md](file://performance_recommendations.md#L90-L107)

## Nginx 反向代理配置
Nginx 作为反向代理层，提供静态文件服务、SSL 终止和请求转发功能。

### Nginx 配置示例
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # SSL 终止
    listen 443 ssl;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/privkey.pem;

    # 静态文件服务
    location /static/ {
        alias /app/frontend/dist/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 请求转发
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket 支持
    location /ws/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 配置要点
- **静态文件服务**：Nginx 直接提供前端资源，减轻后端压力。
- **SSL 终止**：在 Nginx 层处理 HTTPS 加解密，简化后端配置。
- **请求转发**：将 `/api/` 和 `/ws/` 路径请求代理至后端服务。
- **安全头设置**：正确传递客户端真实 IP 和协议信息。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L90-L107)

## Docker 部署优化建议
采用多阶段构建策略优化 Docker 镜像，减少体积并提升安全性。

### 多阶段构建 Dockerfile 示例
```dockerfile
# 构建阶段
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# 运行阶段
FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /root/.local /root/.local
COPY . .
ENV PATH=/root/.local/bin:$PATH
USER 1000

EXPOSE 8000
CMD ["gunicorn", "app.main:app", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000"]
```

### 优化措施
- **多阶段构建**：分离构建环境与运行环境，显著减小最终镜像大小。
- **非 root 用户运行**：提升容器安全性。
- **依赖预安装**：利用 Docker 层缓存加速构建过程。
- **精简基础镜像**：使用 `slim` 版本减少攻击面。

**Section sources**
- [performance_recommendations.md](file://performance_recommendations.md#L90-L107)

## 结论
本文档系统性地介绍了“龟甲交易系统”的部署环境配置方法。通过 `app/core/config.py` 实现了灵活的环境变量驱动配置，结合 `run.py` 完成本地开发启动。生产环境推荐采用 Gunicorn + Uvicorn 组合提升并发能力，Nginx 作为反向代理实现静态文件服务、SSL 终止和负载均衡。Docker 多阶段构建确保了部署镜像的轻量化与安全性。遵循本指南可构建稳定、高效、安全的生产部署环境。