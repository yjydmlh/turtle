# 手动触发数据拉取

<cite>
**本文档引用文件**  
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py)
- [exceptions.py](file://app/core/exceptions.py)
- [kline.py](file://app/schemas/kline.py)
- [api.py](file://app/api/v1/api.py)
</cite>

## 目录
1. [简介](#简介)
2. [接口概述](#接口概述)
3. [异步操作机制](#异步操作机制)
4. [响应结构说明](#响应结构说明)
5. [调用示例](#调用示例)
6. [错误处理与重试策略](#错误处理与重试策略)
7. [自动化脚本最佳实践](#自动化脚本最佳实践)

## 简介

`/simple/fetch-data` 是缠论分析系统中的关键API端点，用于手动触发从币安（Binance）API拉取最新市场数据的后台任务。该接口设计为异步执行，调用后立即返回，不阻塞客户端请求，适合集成到自动化流程或用户界面中。

本文档详细说明该接口的行为特性、返回结构、使用建议及在自动化脚本中的安全调用方式，帮助开发者避免因数据延迟而导致的误判。

## 接口概述

`POST /api/v1/simple/fetch-data` 端点用于触发后台数据获取任务，从币安API获取最近2小时的1分钟K线数据，并将其聚合存储到本地数据库中。此操作是系统更新市场数据的主要方式之一。

该接口属于简化版K线API模块，通过 `kline_simple.py` 中的 `fetch_new_data()` 函数实现，由 `SimpleBinanceDataFetcher` 类负责与币安API通信并处理数据持久化。

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L142-L176)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py#L43-L85)

## 异步操作机制

该接口采用**异步非阻塞设计**，其核心行为如下：

1. **立即响应**：当客户端发送POST请求后，服务器立即启动一个后台任务来获取数据，但不会等待任务完成。
2. **后台执行**：数据获取和数据库写入操作在服务器端异步执行，可能需要数秒时间完成。
3. **不保证即时可见**：调用成功返回后，新数据**尚未完全写入数据库**，直接查询可能无法看到最新结果。

这种设计避免了长时间的HTTP连接等待，提升了系统响应性，但也要求调用者理解其延迟特性。

### 建议等待策略

为确保数据已写入，建议在调用此接口后：

1. **等待2-3秒**：让后台任务有足够时间完成数据获取和数据库提交。
2. **再查询数据**：使用 `/api/v1/simple/klines` 或 `/api/v1/simple/latest` 获取最新K线数据。

这一建议已在响应的 `next_steps` 字段中明确提示。

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L168-L176)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py#L75-L105)

## 响应结构说明

成功调用该接口后，返回标准的JSON响应结构，遵循系统统一的成功响应格式。

```json
{
  "success": true,
  "code": 0,
  "message": "数据获取成功",
  "data": {
    "status": "success",
    "hours_fetched": 2,
    "note": "数据已更新，建议等待2-3秒后重新查询K线数据",
    "next_steps": [
      "等待2-3秒让数据写入完成",
      "调用 /api/v1/simple/klines 查看新数据",
      "调用 /api/v1/chan/analyze 进行缠论分析"
    ]
  }
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `code` | integer | 状态码，0表示成功 |
| `message` | string | 简要描述信息 |
| `data.status` | string | 数据获取状态（如 "success"） |
| `data.hours_fetched` | integer | 获取的时间范围（小时） |
| `data.note` | string | 操作提示，包含等待建议 |
| `data.next_steps` | array[string] | 后续操作建议列表 |

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L168-L176)
- [exceptions.py](file://app/core/exceptions.py#L95-L110)

## 调用示例

### 使用 curl 命令

```bash
# 触发数据拉取
curl -X POST "http://localhost:8000/api/v1/simple/fetch-data"

# 推荐：等待2-3秒后查询最新K线
sleep 3
curl "http://localhost:8000/api/v1/simple/latest?timeframe=1h&count=10"
```

### 使用 Python 脚本

```python
import requests
import time

# 1. 触发数据获取
response = requests.post("http://localhost:8000/api/v1/simple/fetch-data")
result = response.json()

if result["success"]:
    print("✅ 数据获取任务已启动")
    
    # 2. 遵循建议：等待2-3秒
    print("⏳ 等待2秒让数据写入...")
    time.sleep(2)
    
    # 3. 查询最新数据
    kline_response = requests.get(
        "http://localhost:8000/api/v1/simple/latest",
        params={"timeframe": "1h", "count": 5}
    )
    print("📊 最新K线数据:", kline_response.json())
else:
    print("❌ 数据获取失败:", result["message"])
```

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L142-L176)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py#L347-L391)

## 错误处理与重试策略

当数据获取失败时，接口会返回错误响应，包含错误码和描述信息。

```json
{
  "success": false,
  "code": 5001,
  "message": "数据获取失败",
  "data": null
}
```

### 常见错误原因

- **网络连接问题**：无法连接币安API
- **API限流**：请求过于频繁
- **数据库异常**：写入失败
- **数据验证失败**：K线数据格式异常

### 安全重试逻辑

在自动化脚本中，应实现带退避的重试机制：

```python
import time
import requests
from typing import Dict

def safe_fetch_data(max_retries: int = 3, backoff_factor: float = 1.5) -> Dict:
    """安全地调用数据拉取接口，包含重试逻辑"""
    url = "http://localhost:8000/api/v1/simple/fetch-data"
    
    for attempt in range(max_retries):
        try:
            response = requests.post(url, timeout=10)
            result = response.json()
            
            if result["success"]:
                print(f"✅ 数据获取成功 (尝试 {attempt + 1})")
                return result
                
            print(f"⚠️ 获取失败 (尝试 {attempt + 1}): {result['message']}")
            
        except requests.RequestException as e:
            print(f"⚠️ 请求异常 (尝试 {attempt + 1}): {e}")
        
        # 计算退避时间
        if attempt < max_retries - 1:
            wait_time = backoff_factor ** attempt
            print(f"🔁 {wait_time}秒后重试...")
            time.sleep(wait_time)
    
    raise Exception(f"❌ 经过{max_retries}次重试后仍失败")

# 使用示例
try:
    result = safe_fetch_data()
    time.sleep(3)  # 等待数据写入
    # 继续后续分析...
except Exception as e:
    print(f"操作失败: {e}")
```

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L170-L175)
- [exceptions.py](file://app/core/exceptions.py#L75-L94)

## 自动化脚本最佳实践

为确保在自动化流程中正确使用此接口，请遵循以下最佳实践：

1. **始终等待**：调用后必须等待2-3秒再查询数据。
2. **检查响应**：先验证 `success` 字段，再进行后续操作。
3. **实现重试**：对网络或临时错误实现指数退避重试。
4. **避免高频调用**：该接口已启用速率限制，频繁调用可能导致失败。
5. **结合健康检查**：可先调用 `/health` 确认系统状态。

通过遵循这些实践，可以确保数据获取流程的稳定性和可靠性。

**Section sources**
- [kline_simple.py](file://app/api/v1/endpoints/kline_simple.py#L142-L176)
- [simple_fetch_data.py](file://app/scripts/simple_fetch_data.py#L43-L85)
- [api.py](file://app/api/v1/api.py#L0-L12)