# 缠论自动交易系统开发计划

## 系统概述

基于现有缠论分析系统，扩展为完整的自动交易平台，支持模拟交易和实盘交易，提供完整的用户管理、策略订阅、跟单、资管、风控和代理系统。

## 技术栈

- **后端**: FastAPI + PostgreSQL + SQLAlchemy
- **前端**: Svelte + KLineCharts + TailwindCSS
- **图表**: KLineCharts Pro
- **交易所对接**: CCXT库（支持多个交易所）

## 核心模块设计

### 一、用户认证与授权系统

#### 1.1 数据库模型 (`app/models/`)
- `User`: 用户基础信息（id, username, email, password_hash, role, status, created_at）
- `UserProfile`: 用户扩展信息（avatar, phone, real_name, id_card等）
- `Role`: 角色表（admin, trader, follower, agent等）
- `Permission`: 权限表
- `UserRole`: 用户角色关联表

#### 1.2 认证服务 (`app/services/auth/`)
- `auth_service.py`: JWT token生成和验证
- `password_service.py`: 密码加密和验证
- `oauth_service.py`: OAuth2认证流程

#### 1.3 API端点 (`app/api/v1/endpoints/auth.py`)
- `POST /auth/register`: 用户注册
- `POST /auth/login`: 用户登录
- `POST /auth/refresh`: 刷新token
- `GET /auth/me`: 获取当前用户信息
- `PUT /auth/profile`: 更新用户资料

### 二、数据源管理系统

#### 2.1 数据库模型
- `DataSource`: 数据源配置（id, name, type, config_json, status, user_id）
- `DataSourceType`: 支持的数据源类型枚举（BINANCE, OKX, COINBASE, CUSTOM等）

#### 2.2 数据源适配器 (`app/services/data_source/`)
- `base_adapter.py`: 抽象基类，定义统一接口
- `binance_adapter.py`: 币安数据源适配器
- `okx_adapter.py`: OKX数据源适配器
- `ccxt_adapter.py`: 基于CCXT的通用适配器
- `data_source_factory.py`: 数据源工厂类

#### 2.3 API端点 (`app/api/v1/endpoints/data_source.py`)
- `GET /data-sources`: 获取数据源列表
- `POST /data-sources`: 创建数据源
- `PUT /data-sources/{id}`: 更新数据源配置
- `DELETE /data-sources/{id}`: 删除数据源
- `POST /data-sources/{id}/test`: 测试数据源连接

#### 2.4 前端界面 (`frontend/src/lib/components/`)
- `DataSourceManager.svelte`: 数据源管理界面
- `DataSourceForm.svelte`: 数据源配置表单

### 三、交易系统

#### 3.1 数据库模型
- `ExchangeAccount`: 交易所账户（id, user_id, exchange, api_key_hash, api_secret_hash, testnet, status）
- `Order`: 订单表（id, user_id, strategy_id, symbol, side, type, price, quantity, status, filled_qty, exchange_order_id, created_at）
- `Position`: 持仓表（id, user_id, symbol, side, quantity, entry_price, current_price, unrealized_pnl）
- `Trade`: 成交记录（id, order_id, price, quantity, fee, timestamp）

#### 3.2 交易服务 (`app/services/trading/`)
- `trading_service.py`: 交易核心服务（下单、撤单、查询）
- `exchange_adapter.py`: 交易所适配器接口
- `binance_trading.py`: 币安交易适配器
- `okx_trading.py`: OKX交易适配器
- `simulator_service.py`: 模拟交易服务
- `order_manager.py`: 订单管理器

#### 3.3 策略执行引擎 (`app/services/strategy/`)
- `strategy_executor.py`: 策略执行器
- `signal_handler.py`: 信号处理器
- `position_manager.py`: 持仓管理器

#### 3.4 API端点 (`app/api/v1/endpoints/trading.py`)
- `POST /trading/orders`: 创建订单
- `GET /trading/orders`: 查询订单列表
- `DELETE /trading/orders/{id}`: 撤销订单
- `GET /trading/positions`: 查询持仓
- `GET /trading/balance`: 查询账户余额
- `POST /trading/simulate/orders`: 模拟下单

### 四、策略系统

#### 4.1 数据库模型
- `Strategy`: 策略表（id, name, description, type, config_json, is_public, price, creator_id）
- `UserStrategy`: 用户策略订阅（id, user_id, strategy_id, status, subscribed_at, expires_at）
- `StrategySignal`: 策略信号（id, strategy_id, symbol, signal_type, price, confidence, created_at）

#### 4.2 策略服务 (`app/services/strategy/`)
- `strategy_registry.py`: 策略注册中心
- `chan_strategy_v1.py`: 缠论策略1（基于现有多级别策略）
- `chan_strategy_v2.py`: 缠论策略2（区间套策略）
- `strategy_backtest.py`: 策略回测服务

#### 4.3 API端点 (`app/api/v1/endpoints/strategy.py`)
- `GET /strategies`: 获取策略列表
- `POST /strategies`: 创建策略
- `GET /strategies/{id}`: 获取策略详情
- `POST /strategies/{id}/subscribe`: 订阅策略
- `POST /strategies/{id}/unsubscribe`: 取消订阅
- `POST /strategies/{id}/backtest`: 策略回测

### 五、跟单系统

#### 5.1 数据库模型
- `Trader`: 交易者信息（id, user_id, total_profit, win_rate, followers_count, status）
- `FollowRelation`: 跟单关系（id, follower_id, trader_id, follow_type, scale_ratio, max_position, status）
- `FollowOrder`: 跟单订单（id, follow_relation_id, trader_order_id, follower_order_id, scale_ratio, status）

#### 5.2 跟单服务 (`app/services/copy_trading/`)
- `copy_trading_service.py`: 跟单核心服务
- `order_copier.py`: 订单复制器（支持完全复制、比例复制）
- `signal_follower.py`: 信号跟随服务

#### 5.3 API端点 (`app/api/v1/endpoints/copy_trading.py`)
- `GET /copy-trading/traders`: 获取交易者列表
- `POST /copy-trading/follow`: 开始跟单
- `POST /copy-trading/unfollow`: 取消跟单
- `GET /copy-trading/following`: 获取我的跟单列表
- `GET /copy-trading/followers`: 获取我的跟单者列表

### 六、资管系统

#### 6.1 数据库模型
- `Account`: 账户表（id, user_id, name, type, balance, frozen_balance）
- `SubAccount`: 子账户（id, parent_account_id, name, strategy_id, allocation_ratio）
- `Portfolio`: 投资组合（id, user_id, name, total_value, total_cost）
- `PortfolioPosition`: 组合持仓（id, portfolio_id, symbol, quantity, avg_price）

#### 6.2 资管服务 (`app/services/asset_management/`)
- `account_service.py`: 账户管理服务
- `portfolio_service.py`: 投资组合管理
- `allocation_service.py`: 资金分配服务

#### 6.3 API端点 (`app/api/v1/endpoints/asset_management.py`)
- `GET /accounts`: 获取账户列表
- `POST /accounts`: 创建账户
- `POST /accounts/{id}/transfer`: 账户转账
- `GET /portfolios`: 获取投资组合列表
- `POST /portfolios`: 创建投资组合

### 七、风控系统

#### 7.1 数据库模型
- `RiskConfig`: 风控配置（id, user_id, max_single_position, max_total_position, max_daily_loss, max_drawdown, max_position_per_symbol, status）
- `RiskRule`: 风控规则（id, config_id, rule_type, threshold, action）
- `RiskLog`: 风控日志（id, user_id, rule_type, trigger_value, action_taken, created_at）

#### 7.2 风控服务 (`app/services/risk_management/`)
- `risk_engine.py`: 风控引擎
- `risk_checker.py`: 风控检查器
- `risk_monitor.py`: 实时风控监控

#### 7.3 API端点 (`app/api/v1/endpoints/risk_management.py`)
- `GET /risk/config`: 获取风控配置
- `PUT /risk/config`: 更新风控配置
- `GET /risk/logs`: 获取风控日志

### 八、代理系统

#### 8.1 数据库模型
- `Agent`: 代理表（id, user_id, parent_agent_id, level, commission_rate, total_commission）
- `Commission`: 佣金记录（id, agent_id, from_user_id, order_id, amount, rate, level, status）

#### 8.2 代理服务 (`app/services/agent/`)
- `agent_service.py`: 代理服务
- `commission_calculator.py`: 佣金计算器（支持无限层级）
- `agent_tree.py`: 代理树管理

#### 8.3 API端点 (`app/api/v1/endpoints/agent.py`)
- `GET /agent/tree`: 获取代理树
- `GET /agent/commission`: 获取佣金记录
- `GET /agent/statistics`: 获取代理统计

### 九、订单可视化

#### 9.1 前端组件 (`frontend/src/lib/components/`)
- `OrderOverlay.svelte`: 订单叠加层（在K线图上显示订单）
- `PositionIndicator.svelte`: 持仓指示器
- `OrderList.svelte`: 订单列表面板

#### 9.2 图表集成
- 在KLineCharts上叠加订单标记
- 显示开仓价格、止损止盈线
- 实时更新订单状态

### 十、TradingView样式图表界面

#### 10.1 前端重构 (`frontend/src/routes/`)
- `+page.svelte`: 主交易页面（全屏K线图）
- `ChartContainer.svelte`: 图表容器组件
- `Toolbar.svelte`: 浮动工具栏（隐藏在侧边，可展开）

#### 10.2 工具栏功能
- 数据源切换
- 时间周期选择
- 策略选择和执行
- 订单管理
- 持仓查看
- 风控设置

#### 10.3 缠论可视化增强
- 在K线图上绘制分型、笔、线段
- 中枢区域高亮显示
- 买卖点标记
- 多级别叠加显示

## 数据库迁移

使用Alembic进行数据库版本管理，创建初始迁移文件包含所有新表结构。

## 开发优先级

### Phase 1: 基础架构（2-3周）
1. 用户认证系统
2. 基础数据库模型
3. 数据源管理系统（后端+前端界面）

### Phase 2: 交易核心（3-4周）
4. 交易系统（模拟+实盘）
5. 订单可视化
6. TradingView样式界面重构

### Phase 3: 策略与订阅（2-3周）
7. 策略系统完善
8. 付费订阅系统

### Phase 4: 高级功能（3-4周）
9. 跟单系统
10. 资管系统
11. 风控系统
12. 代理系统

## 关键技术点

1. **JWT认证**: 使用FastAPI的OAuth2PasswordBearer
2. **异步交易**: 使用asyncio处理并发交易请求
3. **WebSocket**: 实时推送订单、持仓、价格更新
4. **任务队列**: 使用Celery处理策略计算、回测等耗时任务
5. **缓存**: 使用Redis缓存策略信号、市场数据
6. **加密存储**: 交易所API密钥使用AES加密存储

## 开发任务清单

### 1. 用户认证与授权系统
- [ ] 实现JWT认证（注册、登录、权限管理）
- [ ] 创建用户相关数据库模型（User、Role、Permission等）

### 2. 数据源管理系统
- [ ] 实现数据源管理系统后端（适配器模式、工厂模式）
- [ ] 实现数据源管理前端界面（可视化配置、测试连接）

### 3. 交易系统
- [ ] 创建交易相关数据库模型（Order、Position、Trade、ExchangeAccount）
- [ ] 实现交易系统核心服务（下单、撤单、模拟交易、实盘交易）
- [ ] 实现订单可视化（在K线图上显示订单、持仓标记）

### 4. 图表界面重构
- [ ] 重构图表界面为TradingView样式（全屏K线、浮动工具栏）
- [ ] 增强缠论可视化（在K线图上绘制分型、笔、线段、中枢）

### 5. 策略系统
- [ ] 创建策略相关数据库模型（Strategy、UserStrategy、StrategySignal）
- [ ] 实现策略注册中心和多种缠论策略
- [ ] 实现付费订阅系统（策略订阅、支付集成）

### 6. 跟单系统
- [ ] 创建跟单系统数据库模型（Trader、FollowRelation、FollowOrder）
- [ ] 实现跟单系统服务（完全复制、信号跟随、比例跟单）

### 7. 资管系统
- [ ] 创建资管系统数据库模型（Account、SubAccount、Portfolio）
- [ ] 实现资管系统（多账户管理、投资组合、资金分配）

### 8. 风控系统
- [ ] 创建风控系统数据库模型（RiskConfig、RiskRule、RiskLog）
- [ ] 实现风控系统（单笔限制、仓位控制、亏损限制、回撤控制）

### 9. 代理系统
- [ ] 创建代理系统数据库模型（Agent、Commission）
- [ ] 实现代理系统（无限层级代理、佣金计算）

### 10. 实时通信
- [ ] 实现WebSocket实时推送（订单、持仓、价格更新）

## 用户需求总结

根据用户需求确认：
- **交易执行**: 支持模拟交易和真实交易所API（1c）
- **数据源管理**: 可视化数据源管理界面，支持动态添加/删除（2b）
- **跟单系统**: 支持完全复制、信号跟随、比例跟单（3abc）
- **资管系统**: 单一账户、多账户管理、投资组合管理（4abc）
- **风控系统**: 单笔限制、仓位控制、亏损限制、回撤控制、单品种限制（5abdfg）
- **代理系统**: 无限层级代理，每层可设置不同抽水比例（6b）

---

**文档创建时间**: 2024年
**项目**: 缠论自动交易系统
**技术栈**: FastAPI + PostgreSQL + Svelte + KLineCharts

